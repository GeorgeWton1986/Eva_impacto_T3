---
title: "EVALUACIÓN DE IMPACTO - TALLER 3"
author: "VIÁFARA MORALES, JORGE ELIECER"
date: "2025-09-13"
output:
  pdf_document: default
  html_document: default
  word_document: default
---

## Introduccion
En su artículo, “The Miracle of Microfinance? Evidence form a Randomized Evaluation” , Banerjee, Duflo, Glennerster y Kinnan (2015) reportan en su artículo el impacto de la introducción de un producto de préstamo microcrédito estándar basado en grupos. Lo hacen diseñando una evaluación aleatoria en la región de Hyderabad, India. Para este contexto específico, los autores encuentran que la expansión de las instituciones de microfinanzas (IMF) no es una estrategia efectiva para el alivio rápido de la pobreza, lo que es contrario a lo que generalmente se afirma.

Su tarea es replicar algunos de los resultados obtenidos por los autores y explicar cómo estos permitieron las conclusiones presentadas en el trabajo. Tenga en cuenta la última versión del paper, adjunto aquí junto con el conjunto de datos “data_endlines_1and2.dta”. En general, cuando requiera incluir variables de control, emplee las siguientes: 
- población (area_pop_base), 
- total de negocios (area_business_total_base), 
- gasto promedio per capita (area_exp_pc_mean_base), 
- fracción de jefes de hogar que saben leer y escribir (area_literate_head_base), 
- fracción de adultos que saben leer y escribir (area_literate_base).

Como su solución a este conjunto de problemas, proporcione un documento PDF autocontenido con sus respuestas y el do (u otro programa) que usó para resolverlo. Por favor, asegúrese de que esté claro tanto en su documento como en el do-file, a qué parte del conjunto de problemas corresponde cada solución y código. No seguir estas instrucciones básicas resultará en penalizaciones en su calificación.

Se recomienda tener respuestas tan breves como sea posible. Ciertas preguntas, sobre todo aquellas que preguntan por su opinión, pueden no tener una única respuesta correcta. Así, lo importante es que argumenten de manera coherente.  

## Primer Punto
1. Al introducir el artículo, los autores analizaron las limitaciones y lineamientos de la investigación de microcrédito publicada.  

### Solución Primer Punto

a) ¿Cuáles son los problemas en la identificación del impacto del microcrédito si uno simplemente compara los que tienen microcrédito y los que no tienen microcrédito?

**Respuesta:** Se presentaron dos problemas en la identificación. El primero, autoselección de la muestra dado que los clientes se autoseleccionan para solicitar un crédito. El segundo, la selección de áreas en las que operan las organizaciones de microfinanzas. 

b)¿Qué método utilizan los autores para identificar tal impacto?

**Respuesta:** Los autores estimaron el impacto de las microfinanzas a partir del método Intención de Tratar (ITT).

c) ¿Cómo resuelve ese método los problemas antes mencionados?

**Respuesta:** El método de Intención de Tratar (ITT) permite resolver bajo comparaciones simples de los promedios en las áreas de tratamiento y las áreas de comparación, promediadas entre prestatarios y como no prestatarios. Por lo tanto, el ITT mide el efecto promedio de un acceso más facíl a las microfinanzas.

Manual avanzado de R markdown: https://rpubs.com/ricardo/14631 

## Segundo Punto
2. Los autores reportan los resultados de estimar la siguiente ecuación:

\begin{align}
y_{ia} = \alpha+ \beta Treat_{ia} + X^T_{a}\gamma_1+\epsilon_{i} \quad \nonumber \\
\end{align}

Donde:
- $y_{ia}$ es un resultado para el hogar $i$ en el área $a$.
- $Treat_{ia}$ es una dicótoma que toma el valor de 1 si el hogar está ubicado en un área tratada.
- $\beta$ es el efecto Intention to Treat (ITT). 
- $X^T_{a}$ es un vector con dimensión.
- $Kx1$ de variables de control.

### Solución Segundo Punto

a)	¿Cuál es la unidad de análisis en el estudio?

**Respuesta:** La unidad de análisis del estudio es $y_{ia}$ es el resultado para el hogar $i$ en el área $a$.

Siga la ecuación (1) y use la base de datos “data_endlines_1and2.dta" para realizar las siguientes tareas:

b)	Replique la tabla 2 panel A, columnas 1 y 3 para mostrar el efecto de microfinanzas (ser tratado por el programa) en la obtención de más préstamos (acceso a créditos). Explique la intuición detrás de los resultados. Presente sus resultados con 4 cifras significativas.

Pista: incluya la deuda presente en el área en línea base (área_debt_total_base) como un control adicional y lea las notas de la tabla para obtener exactamente las mismas estimaciones de los parámetros. (Use la función pweight con los pesos en “w1” para corregir por sobremuestreo y cluster para agrupar los errores a nivel de área)

**Respuesta:**

### Generalidades de R
```{r}
#Limpiar la consola
cat("\f")

#Limpiar el Global Environment
rm(list = ls())

#Incluir las librerias
if(!require(pacman)) install.packages("pacman") ; require(pacman)
p_load(haven,   #Leer archivos .dta
      dplyr,    #Manipular datos
      stargazer,  #Visualizar tablas de regresión
      fixest,   #Calcular los efectos fijos
      plm,  #Datos de panel
      knitr,   #Visualizar tablas adicionales
      ivreg,  #Regresiones por variables instrumentales
      broom, #Extraer resultados de regresiones
      AER,    #Regresiones por variables instrumentales
      sandwich, #Errores estándar robustos
      lmtest,  #Pruebas estadísticas
      kableExtra #Tablas avanzadas
      )
```

### Transformación de datos en R
```{r}
# Definir URL del repositorio
github_url <- "https://raw.githubusercontent.com/GeorgeWton1986/Eva_impacto_T3/main"
# Cargar datos
BD_0 <- read_dta(paste0(github_url, "/Data/data_1.dta"))

# Ver estructura de los datos
#glimpse(BD_0)
#head(BD_0)

# Verificar los nombres de la columnas
colnames(BD_0)
```

### Desarrollo 
```{r warning=FALSE, message=FALSE}
#filtrar los datos de endline 1
el1_data <- BD_0 %>% filter(sample1 == 1)

#Verificar que tenemos los datos correctos
cat("Observaciones en endline 1:", nrow(el1_data), "\n")

#Variables de control especificadas
controls_formula <- "area_pop_base + area_business_total_base + 
                      area_exp_pc_mean_base + area_literate_head_base + 
                      area_literate_base + area_debt_total_base"

#Regresión Tabla 2 columna 1 spandana_1
mod_1 <- feols(as.formula(paste("spandana_1 ~ treatment +", controls_formula)), 
               data = el1_data, 
               weights = ~w1, 
               cluster = ~areaid)

#Regresión Tabla 2 columna 3 anymfi_1
mod_3 <- feols(as.formula(paste("anymfi_1 ~ treatment +", controls_formula)), 
                    data = el1_data, 
                    weights = ~w1,
                    cluster = ~areaid)

#Extraer coeficientes y errores estándar
coef_mod_1 <- round(coef(mod_1)["treatment"], 3)
se_mod_1 <- round(se(mod_1)["treatment"], 3)
pval_mod_1 <- round(pvalue(mod_1)["treatment"], 3)

coef_mod_3 <- round(coef(mod_3)["treatment"], 3)
se_mod_3 <- round(se(mod_3)["treatment"], 3)
pval_mod_3 <- round(pvalue(mod_3)["treatment"], 3)

#Crear tabla de resultados
results_1_3 <- data.frame(
  Variable = c("Spandana (Columna 1)", "Any MFI (Columna 3)"),
  Coeficiente = c(coef_mod_1, coef_mod_3),
  Error_Estandar = c(se_mod_1, se_mod_3),
  P_valor = c(pval_mod_1, pval_mod_3),
  Observaciones = c(nobs(mod_1), nobs(mod_3))
)

# #Mostrar tabla
# cat("\n=== RESULTADOS PREGUNTA 2b ===\n")
# print(results_1_3)

etable(mod_1, mod_3,
       title = "Tabla 2, Panel A - Efecto del Tratamiento en Acceso a Crédito",
       headers = c("Spandana", "Any MFI"),
       keep = "treatment",
       digits = 4)

```
**Intuición sobre los resultados (Spandana):** De acuerdo con los resultados obtenidos, incluir una institución que ofrezca microcréditos en el área del tratamiento aumenta la probabilidad de gestionar y recibir un préstamo. Es decir, por su cercania y el voz a voz entre individuos cercanos generan el efecto positivo de tener un 12.7 puntos porcentuales más de probabilidad de recibir un crédito de Spandana en comparación con las areas que no estan tratadas. Presenta una significancia estadística al 1%.

**Intuición sobre los resultados (Any MFI):** Conforme a los resultados presentados, la solicitud y obtención de microcréditos en las áreas de tratamiento, los hogares tienen una probabilidad de 8.4 puntos porcentuales de solicitud de créditos a cualquier IMF. Presenta una significancia estadística al 1%.

**En conclusión:** La diferencia entre columnas 1 y 3 sugiere que algunas personas que habrían tomado préstamos de otras IMFs ahora los toman de Spandana. Además, El efecto neto en 'cualquier IMF' es menor, indicando sustitución.

c)	Replique la tabla 3 panel A, columnas  3 y 4. Explique la intuición detrás de los resultados. Recuerde incluir la corrección por sobremuestreo y errores cluster a nivel de área.

**Respuesta:** La tabla 3 panel A, presenta los resultados de la primera encuesta Endline 1. Los datos representan los impactos de acceso al microcrédito en emprendimientos.

```{r warning=FALSE, message=FALSE}
#Variables de control especificadas
controls_formula_1 <- "area_pop_base + area_business_total_base + area_exp_pc_mean_base + 
                        area_literate_head_base + area_literate_base"

#Regresión Tabla 3 Expenses Columna 3
mod_3_3 <- feols(as.formula(paste("bizexpense_1 ~ treatment+", controls_formula_1)), 
               data = el1_data, 
               weights = ~w1, 
               cluster = ~areaid)

#Regresión Tabla 3 profit Columna 4
mod_3_4 <- feols(as.formula(paste("bizprofit_1 ~ treatment+", controls_formula_1)), 
               data = el1_data, 
               weights = ~w1, 
               cluster = ~areaid)

#Extraer coeficientes y errores estándar con 4 cifras significativas
coef_expenses <- round(coef(mod_3_3)["treatment"], 4)
se_expenses <- round(se(mod_3_3)["treatment"], 4)
pval_expenses <- round(pvalue(mod_3_3)["treatment"], 4)

coef_profit <- round(coef(mod_3_4)["treatment"], 4)
se_profit <- round(se(mod_3_4)["treatment"], 4)
pval_profit <- round(pvalue(mod_3_4)["treatment"], 4)

results_2c <- data.frame(
  Variable = c("Gastos Negocio (Col 3)", "Ganancias Negocio (Col 4)"),
  Coeficiente = c(coef_expenses, coef_profit),
  Error_Estandar = c(se_expenses, se_profit),
  P_valor = c(pval_expenses, pval_profit),
  Observaciones = c(nobs(mod_3_3), nobs(mod_3_4))
)

# cat("\n=== RESULTADOS PREGUNTA 2c ===\n")
# print(results_2c)

#Mostrar tabla

etable(mod_3_3, mod_3_4,
       title = "Tabla 3, Panel A - Actividades de Autoempleo",
       headers = c("Gastos (Col 3)", "Ganancias (Col 4)"),
       keep = "treatment",
       digits = 4)

```

**Intuición sobre los resultados (Expenses):** El resultado de la varible área tratada indica la diferencia promedio los gastos promedios mensuales de los negocios entre los tratados y el área de control. La significancia estadística sugiere que la variable que el microcrédito no tuvo un impacto en los gastos de los negocios. Es decir, los hogares gastaron 216 rupias más que los hogares en la áreas de control.

**Intuición sobre los resultados (Profit):** La utilidad de los negocios de los hogares en las áreas tratadas representó un cambio de 377 rupias en comparación a aquellos hogares en el áreas de control. Sin embargo, el resultado no es significante estadísticamente. Por lo tanto, las utilidades de los negocios no representan expansión de oportunidades para los negocios, debido a que el consumo total promedio de los hogares es aproximadamente 6.500 rupias al mes.

**En conclusión:** La primera encuenta Endline 1, no presenta evidencia sobre el impacto estadísticos significativo de acceso al microcrédito por lo hogares en los gastos y utilidades de los negocios.

d)	Usando “any MFI” como definición del tratamiento y “Treated Area” como asignación aleatoria inicial, calcule la tasa de cumplimiento (compliance rate).  ¿Parece ser alta o baja? (Nota: incluya el ajuste para sobremuestreo)

**Respuesta:** La relación de cumplimiento (compliance rate) esta midiendo la efectividad del experimiento en términos de la diferencias entre $compliance = P(tomar MFI | área tratada) - P(tomar MFI | área control)$. Se explica como la fracción adicional de hogares que tomaron los microcréditos dado que estan tratados. Por lo tanto, si la relación de cumplimiento es cercano a 1, significa que casi todos los hogares en las áreas tratadas tomaron microcréditos, mientras que si es cercano a 0, indica que el experimento tuvo poco impacto en la toma de microcréditos.

```{r warning=FALSE, message=FALSE}
#Calcular tasa de cumplimiento
compliance_rate_df <- el1_data %>%
  summarise(
    #Proporción que toma MFI en áreas tratadas
    treated_take_mfi = weighted.mean(anymfi_1[treatment == 1], w1[treatment == 1], na.rm = TRUE),
    #Proporción que toma MFI en áreas control  
    control_take_mfi = weighted.mean(anymfi_1[treatment == 0], w1[treatment == 0], na.rm = TRUE),
    #Tasa de cumplimiento = diferencia
    compliance = treated_take_mfi - control_take_mfi
  )
# cat("\n=== Tasa de Cumplimiento ===\n")
print(compliance_rate_df)
```
Según los resultados, la tasa de cumpliento es de 0.074 o 7.4%, representa un valor bajo. Esto se interpreta como solo 7 hogares de 100 obtuvieron acceso a microcréditos debido al experimento. Además, 18.1% de los hogares de las áreas de control obtuvieron créditos de otras fuentes y el 25.5% tomaron prestamos de IMF. 

## Tercer Punto

3.	Ahora quieres estimar el impacto de recibir efectivamente un microcrédito sobre 2 variables: i) el consumo total (total_exp_mo_pc_1) y ii) los beneficios del negocio (bizprofit_2).

Para ello, se toma como variable de tratamiento efectivo a la dicótoma anymfi_1 que toma el valor de uno si el hogar recibió algún préstamo de cualquier IMF para la línea final 1 y cero en caso contrario. 

Podemos tomar como instrumento el hecho de que la ubicación de los bancos fue aleatoria. Para esto, use como instrumento en sus estimaciones la asignación aleatoria (treatment).

Finalmente, no incluya ningún control en sus estimaciones.

### Solución tercer Punto

a) ¿Cuáles son los supuestos necesarios para que los estimadores de VI sean válidos (en el contexto del artículo)?

**Respuesta:** Los supuestos necesesarios para que los estimadores de VI sean validos son, **i) Relevancia del instrumento** 
$Cov(anymfi\_1,treatment)\neq 0$, **ii) Exclusión** $Cov(\epsilon, treatment) = 0$, **iii) Monotonicidad** $anymfi\_1(1) \geq anymfi\_1(0)$ y **iv) Independencia** $treatment \perp (anymfi\_1(0), anymfi\_1(1), \epsilon)$.

b)	Para cada una de las dos variables, estime el efecto Local Average Treament Effect (LATE) de obtener un préstamo, a través del método de Variable Instrumental. Estime también el ITT.  Para cada tipo de efecto (LATE e ITT) presente una tabla con sus estimaciones y sus respectivos errores estándar. Interprete sus resultados, ¿Cuál es la diferencia en la interpretación de los dos tipos de efecto? Discuta. (Nota: no incluya controles, solo ajuste para sobremuestreo y clusterice errores.)

**Respuesta:** Vamos a explicar los términos ITT (Intent to Treat), es el efecto de ser asignado al tratamiento, independiente si se recibe el tratamiento. El LATE (Local Average Treatment Effect), es el efecto causal del tratamiento en aquellos que cumplen con el tratamiento debido a la asignación aleatoria.
```{r warning=FALSE, message=FALSE}

#i) ITT - Consumo Total
itt_consumption <- lm(total_exp_mo_pc_1 ~ treatment, 
                      data = el1_data, 
                      weights = el1_data$w1)

#i) ATE - Consumo Total (IV)
late_consumption <- ivreg(total_exp_mo_pc_1 ~ anymfi_1 | treatment, 
                          data = el1_data, 
                          weights = el1_data$w1)

#ii) ITT - Ganancias Negocio
itt_profit <- lm(bizprofit_2 ~ treatment, 
                 data = el1_data, 
                 weights = el1_data$w1)

#ii) LATE - Ganancias Negocio (IV)
late_profit <- ivreg(bizprofit_2 ~ anymfi_1 | treatment, 
                     data = el1_data, 
                     weights = el1_data$w1)

#Errores clustereados para ITT
vcov_itt_cons <- vcovCL(itt_consumption, cluster = el1_data$areaid)
vcov_itt_prof <- vcovCL(itt_profit, cluster = el1_data$areaid)

#Errores clustereados para LATE
vcov_late_cons <- vcovCL(late_consumption, cluster = el1_data$areaid)
vcov_late_prof <- vcovCL(late_profit, cluster = el1_data$areaid)


#ITT Coeficentes y Desv. Estandasr Consumo Total
itt_cons_coef <- coef(itt_consumption)["treatment"]
itt_cons_se <- sqrt(diag(vcov_itt_cons))["treatment"]

#LATE Coeficentes y Desv. Estandasr Consumo Total (IV)
late_cons_coef <- coef(late_consumption)["anymfi_1"]
late_cons_se <- sqrt(diag(vcov_late_cons))["anymfi_1"]

#ITT Coeficentes y Desv. Estandasr Ganancias Negocio
itt_prof_coef <- coef(itt_profit)["treatment"] 
itt_prof_se <- sqrt(diag(vcov_itt_prof))["treatment"]

#LATE Coeficentes y Desv. Estandasr Ganancias Negocio (IV)
late_prof_coef <- coef(late_profit)["anymfi_1"]
late_prof_se <- sqrt(diag(vcov_late_prof))["anymfi_1"]

```

```{r warning=FALSE, message=FALSE}
# Crear tabla de resultados combinados ITT y LATE

# Tabla ITT
stargazer(itt_consumption, itt_profit,
          title = "Efectos Intent-to-Treat (ITT)",
          dep.var.labels = c("Consumo Total", "Ganancias Negocio"),
          keep = "treatment",
          covariate.labels = "Área Tratada",
          se = list(sqrt(diag(vcov_itt_cons))[2], 
                    sqrt(diag(vcov_itt_prof))[2]),
          digits = 1,
          type = "text",
          font.size = "small",
          notes = "Errores estándar clustereados por área.")

```
```{r warning=FALSE, message=FALSE}
# Crear tabla de resultados combinados ITT y LATE
# Tabla LATE
stargazer(late_consumption, late_profit,
          title = "Efectos Local Average Treatment (LATE)",
          dep.var.labels = c("Consumo Total", "Ganancias Negocio"),
          keep = "anymfi_1",
          covariate.labels = "Any MFI",
          se = list(sqrt(diag(vcov_late_cons))[2], 
                    sqrt(diag(vcov_late_prof))[2]),
          digits = 1,
          type = "text",
          font.size = "small",
          add.lines = list(c("Compliance Rate", "7.4\\%", "7.4\\%")),
          notes = "Errores estándar clustereados por área.")

```

**Interpretación de Resultados:** En términos prácticos el efecto ITT indica que el acceso al microcrédito en una zona que facilita el crédito (Zona Tratada), es independiente de si el hogar efectivamente tome el crédito. La interpretación cuantitativa del ITT, presenta un aumento a consumir en promedio 38 rupias mensuales. Además, puede facilitar un aumento en las ganancias del negocio en 585 rupias mensuales en promedio debido al acceso al microcrédito. Sin embargo, ambos resultados no son estadisticamente significativos, resultados que coinciden con los autores.

De otro lado, el efecto LATE bajo condiciones de aleatoriedad estima que tomar un microcrédito aumenta el consumo en 460 rupias mensuales y aumenta las ganancias del negocio en 6585 rupias mensuales en promedio para ambos casos. Por lo tanto, el LATE mide el efecto causal de tomar el credito solo para aquellos "compliers". Es decir, aquellos hogares que toman el crédito porque su acceso fue facilitado por la asignación aleatoría.

c)	¿Cuál debería ser la relación matemática entre la tasa de cumplimiento, el LATE y el ITT? ¿Parece mantenerse esta relación en sus resultados? En una tabla presente sus cálculos de LATE matemáticos/manuales y discuta. 

**Respuesta:**
```{r warning=FALSE, message=FALSE}

#Importante: LATE = ITT / Compliance Rate

compliance_rate <- compliance_rate_df$compliance

# Calcular LATE "manual" usando la fórmula
late_manual_consumo <- itt_cons_coef / compliance_rate
late_manual_ganancias <- itt_prof_coef / compliance_rate

# Crear tabla de verificación
tabla_verificacion <- data.frame(
  Variable = c("Consumo Total", "Ganancias Negocio"),
  
  ITT = c(round(itt_cons_coef, 2), round(itt_prof_coef, 2)),
  
  Compliance_Rate = c(round(compliance_rate, 4), round(compliance_rate, 4)),
  
  LATE_IV = c(round(late_cons_coef, 2), round(late_prof_coef, 2)),
  
  LATE_Manual = c(round(late_manual_consumo, 2), round(late_manual_ganancias, 2)),
  
  Diferencia = c(round(late_cons_coef - late_manual_consumo, 2),
                 round(late_prof_coef - late_manual_ganancias, 2)),
  
  Ratio_LATE_ITT = c(round(late_cons_coef / itt_cons_coef, 2),
                     round(late_prof_coef / itt_prof_coef, 2))
)

head(tabla_verificacion)
```
**Interpretación:** Los resultado confirman la relación matemática $LATE = ITT / Compliance Rate$. Sin embargo, las diferencias indican que el efecto del muestreo y los pesos pueden afectar las estimaciones por OLS y VI. Además, las observaciones de LATE VI son menos para el consumo total. En general, se puede concluir que el Microcrédito tiene efectos causales (LATE) grandes pero solo para una minoria de hogares como lo muestra el compliance rate bajo.
